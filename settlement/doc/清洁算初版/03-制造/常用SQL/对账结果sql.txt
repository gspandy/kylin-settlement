-- 查询对账结果 平 错 长 短 各结果条数
SELECT
	td.MERCHANT_CODE as 机构,
	td.PAY_CHANNEL_ID as 渠道,
	td.FUNC_CODE as 业务编码,
	count(*) as 总计,
	sum(CASE td.STATUS_ID WHEN 21 THEN 1 ELSE 0 END) as 平账,
	sum(CASE td.STATUS_ID WHEN 22 THEN 1 ELSE 0 END) as 错款,
	sum(CASE td.STATUS_ID WHEN 24 THEN 1 ELSE 0 END) as 短款
FROM
	SETTLE_TRANS_DETAIL td,
	(SELECT
			OBLIGATE2,
			SUBSTR(OBLIGATE2,1,LOCATE('#',OBLIGATE2) - 1) as c1,
			SUBSTR(OBLIGATE2,LOCATE('#',OBLIGATE2) + 1) as c2
		FROM 
			SETTLE_BALANCE_ENTRY be
		WHERE
			be.STATUS_ID != 11
		AND	be.STATUS_ID != 2
		AND be.UPDATED_TIME LIKE '2016-01-28 %'
	) t1
WHERE
	td.TRANS_DETAIL_ID = t1.c1
GROUP BY 
	td.MERCHANT_CODE,
	td.PAY_CHANNEL_ID,
	td.FUNC_CODE
